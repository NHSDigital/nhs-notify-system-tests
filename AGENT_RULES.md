# Agent Operational Rules

This repository uses upstream template–managed files. The agent MUST follow the rules below when proposing or applying changes.

## 1. Immutable Banner Detection
If a file contains the exact line:
```
# WARNING: Please DO NOT edit this file!
```
(or the extended form including repository template URL) the agent MUST NOT modify, delete, or append content to that file.

### Required Agent Response
When encountering the banner during an edit request:
1. Abort the edit.
2. Reply to the user: "File is template-managed. Raise a PR in https://github.com/nhs-england-tools/repository-template instead." (or appropriate upstream).
3. Offer to copy the file contents into a new override file ONLY if policy allows (user must explicitly ask).

## 2. Scope Limitation
Skip: refactors, formatting, comment changes, renames, permission changes on bannered files.
Allow: Reading, explaining, locating provenance, suggesting upstream changes.

## 3. Pattern Matching Guidance
Primary match: full line equality.
Secondary match: substring beginning with `# WARNING: Please DO NOT edit this file!` to allow future suffix changes.
Do not treat similar but non-identical warnings as immutable unless user confirms.

## 4. Escalation Path
If user insists on editing despite banner:
- Confirm intent: "Editing violates template sync guarantees—proceed only if you intend to fork behavior."
- Require explicit text: "Override accepted" before performing any change.

## 5. Rationale
Template-managed files are centrally maintained for consistency across repositories (security, formatting, hook logic). Local edits create drift and may be overwritten on template sync.

## 6. Suggested Upstream Workflow
1. Open PR in template repository.
2. After merge, run template sync (internal automation or manual script).
3. Re-run pre-commit to verify no local divergence.

## 7. JSON Policy (Optional Future Extension)
If an automation layer parses policy, use:
```json
{
  "immutable_banner": "# WARNING: Please DO NOT edit this file!",
  "actions": {
    "on_match": "abort",
    "message": "Template-managed file. Propose change upstream."
  }
}
```

## 8. Agent Compliance Checklist (Internal)
- [ ] Scan file diff for banner before apply_patch.
- [ ] If present, cancel patch.
- [ ] Provide upstream PR guidance.

## 9. User Override Procedure (Exceptional)
User must explicitly type: `I acknowledge risk; proceed to edit bannered file <path>.`
Agent then:
- Repeats warning.
- Performs only requested minimal edit.
- Adds note in PR/commit message: `Manual override of template-managed file.`

## 10. Language
Use UK English for all comments

---
Maintainers may extend this document with additional immutable markers (e.g., generated code blocks) as needed.
