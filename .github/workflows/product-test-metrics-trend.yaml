name: Product Test Metrics Trend

on:
  pull_request:
    paths:
      - 'tests/test-team/**/*.ts'
      - 'scripts/generate-product-test-metrics.ts'
      - 'scripts/compare-product-test-metrics.ts'
      - '.github/workflows/product-test-metrics-trend.yaml'

jobs:
  metrics-trend:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate current metrics
        run: npm run metrics:product-tests

      - name: Retrieve base metrics (if exists)
        run: |
          git show origin/${{ github.base_ref }}:tests/test-team/metrics/product-test-metrics.json > tests/test-team/metrics/base-product-test-metrics.json || echo '{}' > tests/test-team/metrics/base-product-test-metrics.json

      - name: Compare metrics
        id: compare
        run: |
          npm run metrics:compare > metrics-compare.json || EXIT=$?
          echo "exit_code=${EXIT:-0}" >> $GITHUB_OUTPUT
          echo "report=$(cat metrics-compare.json | tr '\n' ' ')" >> $GITHUB_OUTPUT
          if [ "${EXIT:-0}" -ne 0 ]; then
            echo "Metrics regression detected" >&2
            exit 1
          fi

      - name: Annotate summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const raw = process.env.REPORT || core.getInput('report');
            let summaryJson;
            try { summaryJson = JSON.parse(raw); } catch { summaryJson = { parseError: true, raw }; }
            const regressions = summaryJson.regressions || [];
            await core.summary
              .addHeading('Product Test Metrics Trend')
              .addTable([
                ['Base Metrics Found', String(summaryJson.baseExists)],
                ['Regression Count', String(summaryJson.regressionCount)]
              ])
              .addHeading('Regressions')
            if (regressions.length === 0) {
              core.summary.addRaw('None âœ…');
            } else {
              regressions.forEach(r => {
                core.summary.addRaw(`- ${r.code}: ${r.message}`);\n
              });
            }
            await core.summary.write();
          result-encoding: string
