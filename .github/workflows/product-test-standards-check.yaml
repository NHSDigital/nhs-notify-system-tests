name: Product Test Standards Check

on:
  pull_request:
    paths:
      - 'tests/test-team/**/*.ts'
      - '.github/copilot-instructions.md'
      - 'tests/test-team/standards/TEST_STANDARDS.md'

jobs:
  validate-product-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci

      - name: Run product test standards validator
        id: validate
        run: |
          node --version
          npm run validate:product-tests > validation.json || EXIT=$?
          echo "exit_code=${EXIT:-0}" >> $GITHUB_OUTPUT
          echo "report=$(cat validation.json | tr '\n' ' ')" >> $GITHUB_OUTPUT
          if [ "${EXIT:-0}" -ne 0 ]; then
            echo "Standards validation failed" >&2
            exit 1
          fi

      - name: Annotate summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const reportRaw = process.env.REPORT || core.getInput('report');
            const summary = JSON.parse(reportRaw);
            const files = summary.summary.filesChecked;
            const violations = summary.summary.violations;
            const warnings = summary.summary.warnings;
            await core.summary
              .addHeading('Product Test Standards')
              .addTable([
                ['Files Checked', String(files)],
                ['Violations', String(violations)],
                ['Warnings', String(warnings)]
              ])
              .write();
          result-encoding: string
